{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-chart-bar"></i> Analytics & AI Insights
    </h1>
</div>

<!-- AI Insights Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <i class="fas fa-robot fa-2x text-primary mb-2"></i>
                        <h5>Smart Categorization</h5>
                        <p class="text-muted">AI-powered transaction categorization</p>
                    </div>
                    <div class="col-md-3">
                        <i class="fas fa-crystal-ball fa-2x text-success mb-2"></i>
                        <h5>Predictive Analytics</h5>
                        <p class="text-muted">Future spending forecasts</p>
                    </div>
                    <div class="col-md-3">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <h5>Anomaly Detection</h5>
                        <p class="text-muted">Unusual pattern identification</p>
                    </div>
                    <div class="col-md-3">
                        <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                        <h5>Trend Analysis</h5>
                        <p class="text-muted">Spending pattern insights</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Spending Chart -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-pie"></i> Expense Categories Distribution
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4 pb-2">
                    <canvas id="categoryChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Predictions -->
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-crystal-ball"></i> AI Predictions
                </h6>
            </div>
            <div class="card-body">
                {% if predictions and predictions.estimated_spending > 0 %}
                <div class="alert alert-info">
                    <h6>ðŸ“Š Next Month's Forecast</h6>
                    <p>Based on your current spending patterns, our AI predicts:</p>
                    <div class="text-center my-3">
                        <h3 class="text-primary">â‚¹{{ "%.2f"|format(predictions.estimated_spending) }}</h3>
                        <small class="text-muted">Estimated Monthly Spending</small>
                    </div>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ predictions.confidence }}%" 
                             aria-valuenow="{{ predictions.confidence }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ predictions.confidence }}% Confidence
                        </div>
                    </div>
                    <small class="text-muted">Based on {{ predictions.data_points }} data points</small>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">Insufficient Data</h6>
                    <p class="text-muted small">Add more transactions to get AI predictions</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Spending Trends -->
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-line"></i> Spending Trends
                </h6>
            </div>
            <div class="card-body">
                {% if spending_trends and spending_trends.average_monthly_spending > 0 %}
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="text-primary">
                            <i class="fas fa-rupee-sign fa-2x"></i>
                        </div>
                        <div class="h5">â‚¹{{ "%.2f"|format(spending_trends.average_monthly_spending) }}</div>
                        <small>Avg Monthly Spending</small>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="text-info">
                            <i class="fas fa-chart-bar fa-2x"></i>
                        </div>
                        <div class="h5">{{ spending_trends.total_transactions }}</div>
                        <small>Total Transactions</small>
                    </div>
                </div>
                
                {% if spending_trends.top_categories %}
                <h6>Top Spending Categories:</h6>
                <ul class="list-group list-group-flush">
                    {% for category, count in spending_trends.top_categories.items() %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ category }}
                        <span class="badge bg-primary rounded-pill">{{ count }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
                
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">No Trend Data</h6>
                    <p class="text-muted small">Add more transactions to see spending trends</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Anomaly Detection -->
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-exclamation-triangle"></i> Anomaly Detection
                </h6>
            </div>
            <div class="card-body">
                {% if anomalies and anomalies|length > 0 %}
                <div class="alert alert-warning">
                    <h6>ðŸš¨ Unusual Patterns Detected</h6>
                    <p>Our AI found these unusual transactions:</p>
                    <div class="mt-3">
                        {% for anomaly in anomalies[:3] %}
                        <div class="card mb-2 border-warning">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">{{ anomaly.description }}</h6>
                                <p class="card-text mb-1">
                                    <strong>â‚¹{{ "%.2f"|format(anomaly.amount) }}</strong> â€¢ {{ anomaly.category }}
                                </p>
                                <small class="text-muted">{{ anomaly.date }} â€¢ {{ anomaly.reason }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if anomalies|length > 3 %}
                    <small class="text-muted">... and {{ anomalies|length - 3 }} more anomalies</small>
                    {% endif %}
                </div>
                {% else %}
                <div class="alert alert-success">
                    <h6>âœ… All Clear</h6>
                    <p class="mb-0">No unusual spending patterns detected. Your transactions look normal.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Category Bar Chart -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-bar"></i> Spending by Category
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-bar">
                    <canvas id="spendingChart" width="400" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch category data and create charts
        fetch('/api/transaction_categories')
            .then(response => response.json())
            .then(data => {
                createCategoryChart(data);
                createSpendingChart(data);
            });

        function createCategoryChart(categoryData) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#5a5c69', '#2e59d9'];
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: colors,
                        hoverBackgroundColor: colors,
                        hoverBorderColor: "rgba(234, 236, 244, 1)",
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    tooltips: {
                        backgroundColor: "rgb(255,255,255)",
                        bodyFontColor: "#858796",
                        borderColor: '#dddfeb',
                        borderWidth: 1,
                        xPadding: 15,
                        yPadding: 15,
                        displayColors: false,
                        caretPadding: 10,
                        callbacks: {
                            label: function(tooltipItem, data) {
                                var label = data.labels[tooltipItem.index] || '';
                                var value = data.datasets[0].data[tooltipItem.index];
                                return label + ': â‚¹' + value.toFixed(2);
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: 'bottom'
                    },
                    cutoutPercentage: 70,
                }
            });
        }

        function createSpendingChart(categoryData) {
            const ctx = document.getElementById('spendingChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        label: 'Spending by Category (â‚¹)',
                        data: Object.values(categoryData),
                        backgroundColor: '#4e73df',
                        hoverBackgroundColor: '#2e59d9',
                        borderColor: '#4e73df',
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚¹' + value;
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'â‚¹' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}